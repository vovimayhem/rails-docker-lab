#! /usr/bin/env ruby

# The requires:
require 'rubygems'
require 'rake'
require 'bundler'

# Load the dependencies from the Gemfile:
Bundler.setup(:default)

require 'active_record'
require 'erb'
require 'yaml'

def connection_to_database?
  ActiveRecord.establish_connection && \
  ActiveRecord::Migrator.current_version
end

exit begin
  connection_tries ||= 3
  connection_to_database?
rescue PG::ConnectionBad
  unless (connection_tries -= 1).zero?
    puts "Retrying connection #{connection_tries} more times..."
    sleep ENV.fetch("APP_SETUP_WAIT", 5).to_i
    retry
  end
  exit 1
rescue ActiveRecord::NoDatabaseError
  exit 2
ensure
  ActiveRecord::Base.clear_all_connections!
end
